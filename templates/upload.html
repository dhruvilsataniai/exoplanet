{% extends "base.html" %}

{% block title %}Upload Data - Exoplanet Detection System{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-upload me-2"></i>
                Batch Data Upload
            </h1>
            <p class="lead">
                Upload CSV files containing multiple observations for bulk exoplanet classification.
            </p>
        </div>
    </div>

    <div class="row">
        <!-- Upload Form -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-upload me-2"></i>Upload CSV File
                    </h5>
                </div>
                <div class="card-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file-input" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control" id="file-input" 
                                   name="file" accept=".csv" required>
                            <div class="form-text">
                                Maximum file size: 16MB. File must be in CSV format.
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="preview-data" checked>
                                <label class="form-check-label" for="preview-data">
                                    Preview data before processing
                                </label>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-cloud-upload-alt me-1"></i>Upload and Process
                            </button>
                        </div>
                    </form>

                    <!-- File Preview -->
                    <div id="file-preview" class="mt-4" style="display: none;">
                        <h6>File Preview:</h6>
                        <div id="preview-content"></div>
                    </div>
                </div>
            </div>

            <!-- CSV Format Guide -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>CSV Format Guide
                    </h5>
                </div>
                <div class="card-body">
                    <p>Your CSV file should contain the following columns (not all are required):</p>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Column Name</th>
                                    <th>Description</th>
                                    <th>Required</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>orbital_period</code></td>
                                    <td>Orbital period in days</td>
                                    <td><span class="badge bg-danger">Yes</span></td>
                                </tr>
                                <tr>
                                    <td><code>transit_duration</code></td>
                                    <td>Transit duration in hours</td>
                                    <td><span class="badge bg-danger">Yes</span></td>
                                </tr>
                                <tr>
                                    <td><code>transit_depth</code></td>
                                    <td>Transit depth in ppm</td>
                                    <td><span class="badge bg-danger">Yes</span></td>
                                </tr>
                                <tr>
                                    <td><code>planet_radius</code></td>
                                    <td>Planet radius in Earth radii</td>
                                    <td><span class="badge bg-danger">Yes</span></td>
                                </tr>
                                <tr>
                                    <td><code>stellar_temp</code></td>
                                    <td>Stellar temperature in Kelvin</td>
                                    <td><span class="badge bg-warning">Optional</span></td>
                                </tr>
                                <tr>
                                    <td><code>stellar_radius</code></td>
                                    <td>Stellar radius in Solar radii</td>
                                    <td><span class="badge bg-warning">Optional</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate()">
                            <i class="fas fa-download me-1"></i>Download Template
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="generateSampleData()">
                            <i class="fas fa-magic me-1"></i>Generate Sample Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Processing Results
                    </h5>
                </div>
                <div class="card-body">
                    <div id="upload-results" class="text-center text-muted">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <p>Upload a CSV file to see batch prediction results</p>
                    </div>
                </div>
            </div>

            <!-- Results Summary -->
            <div id="results-summary" class="card mt-4" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Results Summary
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="results-chart"></canvas>
                </div>
            </div>

            <!-- Download Results -->
            <div id="download-section" class="card mt-4" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-download me-2"></i>Download Results
                    </h5>
                </div>
                <div class="card-body">
                    <p>Download the prediction results in various formats:</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="downloadResults('csv')">
                            <i class="fas fa-file-csv me-1"></i>Download as CSV
                        </button>
                        <button class="btn btn-info" onclick="downloadResults('json')">
                            <i class="fas fa-file-code me-1"></i>Download as JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentResults = null;

document.addEventListener('DOMContentLoaded', function() {
    // File input change handler
    document.getElementById('file-input').addEventListener('change', handleFileSelect);
    
    // Form submission
    document.getElementById('upload-form').addEventListener('submit', handleUpload);
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Show file info
    const previewDiv = document.getElementById('file-preview');
    const previewContent = document.getElementById('preview-content');
    
    if (document.getElementById('preview-data').checked) {
        // Read and preview file
        const reader = new FileReader();
        reader.onload = function(e) {
            const csv = e.target.result;
            const lines = csv.split('\n').slice(0, 6); // First 5 rows + header
            
            let html = `
                <div class="alert alert-info">
                    <strong>File:</strong> ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
            `;
            
            lines.forEach((line, index) => {
                if (line.trim()) {
                    const cells = line.split(',');
                    html += '<tr>';
                    cells.forEach(cell => {
                        const tag = index === 0 ? 'th' : 'td';
                        html += `<${tag}>${cell.trim()}</${tag}>`;
                    });
                    html += '</tr>';
                }
            });
            
            html += '</table></div>';
            
            if (csv.split('\n').length > 6) {
                html += '<p class="text-muted"><small>... and more rows</small></p>';
            }
            
            previewContent.innerHTML = html;
            previewDiv.style.display = 'block';
        };
        reader.readAsText(file);
    } else {
        previewDiv.style.display = 'none';
    }
}

async function handleUpload(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const resultsDiv = document.getElementById('upload-results');
    
    // Show loading state
    resultsDiv.innerHTML = `
        <div class="d-flex align-items-center justify-content-center">
            <div class="spinner-border me-2" role="status"></div>
            <span>Processing file...</span>
        </div>
    `;
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            currentResults = result;
            displayUploadResults(result);
        } else {
            throw new Error(result.error || 'Upload failed');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
    }
}

function displayUploadResults(result) {
    const resultsDiv = document.getElementById('upload-results');
    
    // Count predictions by class
    const classCounts = {};
    result.predictions.forEach(pred => {
        classCounts[pred.prediction] = (classCounts[pred.prediction] || 0) + 1;
    });
    
    let html = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            Successfully processed <strong>${result.count}</strong> records from 
            <strong>${result.filename}</strong>
        </div>
        
        <div class="row text-center mb-3">
    `;
    
    // Add count cards
    for (const [className, count] of Object.entries(classCounts)) {
        let badgeClass;
        switch (className) {
            case 'CONFIRMED': badgeClass = 'bg-success'; break;
            case 'CANDIDATE': badgeClass = 'bg-warning'; break;
            case 'FALSE_POSITIVE': badgeClass = 'bg-danger'; break;
            default: badgeClass = 'bg-secondary';
        }
        
        html += `
            <div class="col-4 mb-2">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="card-title mb-1">
                            <span class="badge ${badgeClass}">${className.replace('_', ' ')}</span>
                        </h6>
                        <h4 class="mb-0">${count}</h4>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += `
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Prediction</th>
                        <th>Confidence</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Show first 10 results
    result.predictions.slice(0, 10).forEach((pred, index) => {
        let badgeClass;
        switch (pred.prediction) {
            case 'CONFIRMED': badgeClass = 'bg-success'; break;
            case 'CANDIDATE': badgeClass = 'bg-warning'; break;
            case 'FALSE_POSITIVE': badgeClass = 'bg-danger'; break;
            default: badgeClass = 'bg-secondary';
        }
        
        html += `
            <tr>
                <td>${index + 1}</td>
                <td><span class="badge ${badgeClass}">${pred.prediction.replace('_', ' ')}</span></td>
                <td>${(pred.confidence * 100).toFixed(1)}%</td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showDetails(${index})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    
    if (result.predictions.length > 10) {
        html += `<p class="text-muted text-center">... and ${result.predictions.length - 10} more results</p>`;
    }
    
    html += '</div>';
    
    resultsDiv.innerHTML = html;
    
    // Show summary chart
    displayResultsChart(classCounts);
    
    // Show download section
    document.getElementById('download-section').style.display = 'block';
}

function displayResultsChart(classCounts) {
    const ctx = document.getElementById('results-chart').getContext('2d');
    
    const labels = Object.keys(classCounts).map(label => label.replace('_', ' '));
    const data = Object.values(classCounts);
    const colors = labels.map(label => {
        switch (label) {
            case 'CONFIRMED': return '#28a745';
            case 'CANDIDATE': return '#ffc107';
            case 'FALSE POSITIVE': return '#dc3545';
            default: return '#6c757d';
        }
    });
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Prediction Distribution'
                }
            }
        }
    });
    
    document.getElementById('results-summary').style.display = 'block';
}

function showDetails(index) {
    if (!currentResults || !currentResults.predictions[index]) return;
    
    const pred = currentResults.predictions[index];
    const input = pred.input_data;
    
    let html = `
        <div class="modal fade" id="detailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Prediction Details - Record ${index + 1}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Input Parameters:</h6>
                                <table class="table table-sm">
    `;
    
    for (const [key, value] of Object.entries(input)) {
        html += `<tr><td>${key}</td><td>${value}</td></tr>`;
    }
    
    html += `
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Prediction Results:</h6>
                                <p><strong>Prediction:</strong> ${pred.prediction.replace('_', ' ')}</p>
                                <p><strong>Confidence:</strong> ${(pred.confidence * 100).toFixed(1)}%</p>
                                
                                <h6>All Probabilities:</h6>
                                <table class="table table-sm">
    `;
    
    for (const [className, probability] of Object.entries(pred.probabilities)) {
        html += `<tr><td>${className.replace('_', ' ')}</td><td>${(probability * 100).toFixed(1)}%</td></tr>`;
    }
    
    html += `
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('detailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', html);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    modal.show();
}

function downloadTemplate() {
    const csv = `orbital_period,transit_duration,transit_depth,impact_parameter,planet_radius,equilibrium_temp,stellar_temp,stellar_radius,stellar_magnitude,false_positive_flag,koi_score
365.25,13.0,84,0.0,1.0,288,5778,1.0,12.5,0,0.9
88.0,6.5,1200,0.2,1.5,450,5500,0.9,13.2,0,0.8`;
    
    downloadCSV(csv, 'exoplanet_template.csv');
}

function generateSampleData() {
    // Generate 10 sample records
    let csv = 'orbital_period,transit_duration,transit_depth,impact_parameter,planet_radius,equilibrium_temp,stellar_temp,stellar_radius,stellar_magnitude,false_positive_flag,koi_score\n';
    
    for (let i = 0; i < 10; i++) {
        const period = (Math.random() * 1000 + 1).toFixed(2);
        const duration = (Math.random() * 20 + 2).toFixed(1);
        const depth = Math.floor(Math.random() * 5000 + 50);
        const impact = (Math.random() * 0.8).toFixed(2);
        const radius = (Math.random() * 10 + 0.5).toFixed(2);
        const temp = Math.floor(Math.random() * 1000 + 200);
        const stellarTemp = Math.floor(Math.random() * 3000 + 3000);
        const stellarRadius = (Math.random() * 3 + 0.5).toFixed(2);
        const magnitude = (Math.random() * 10 + 8).toFixed(1);
        const fpFlag = Math.floor(Math.random() * 3);
        const score = (Math.random() * 0.5 + 0.5).toFixed(2);
        
        csv += `${period},${duration},${depth},${impact},${radius},${temp},${stellarTemp},${stellarRadius},${magnitude},${fpFlag},${score}\n`;
    }
    
    downloadCSV(csv, 'sample_exoplanet_data.csv');
}

function downloadResults(format) {
    if (!currentResults) return;
    
    if (format === 'csv') {
        // Convert results to CSV
        let csv = 'index,prediction,confidence,';
        
        // Add probability columns
        const classes = Object.keys(currentResults.predictions[0].probabilities);
        csv += classes.map(c => `prob_${c.toLowerCase()}`).join(',');
        
        // Add input parameter columns
        const inputKeys = Object.keys(currentResults.predictions[0].input_data);
        csv += ',' + inputKeys.join(',') + '\n';
        
        // Add data rows
        currentResults.predictions.forEach((pred, index) => {
            csv += `${index + 1},${pred.prediction},${pred.confidence},`;
            csv += classes.map(c => pred.probabilities[c]).join(',');
            csv += ',' + inputKeys.map(k => pred.input_data[k]).join(',') + '\n';
        });
        
        downloadCSV(csv, `exoplanet_predictions_${new Date().toISOString().split('T')[0]}.csv`);
        
    } else if (format === 'json') {
        const json = JSON.stringify(currentResults, null, 2);
        downloadJSON(json, `exoplanet_predictions_${new Date().toISOString().split('T')[0]}.json`);
    }
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

function downloadJSON(content, filename) {
    const blob = new Blob([content], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
